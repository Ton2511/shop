<!-- views/shop/product-details.ejs (Mobile-Optimized) -->
<!-- Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

<style>
    /* Base carousel styles */
    .carousel-wrapper {
        position: relative;
    }

    .carousel-container {
        position: relative;
        overflow: hidden;
        height: 500px;
    }

    .carousel-inner {
        display: flex;
        flex-direction: column;
        transition: transform 0.5s ease-in-out;
    }

    .carousel-item {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 150px;
        max-width: 100%;
    }

    .custom-size {
        width: 100%;
        max-width: 100%;
        height: auto;
        object-fit: cover;
    }

    .custom-size-main {
        width: 100%;
        max-width: 500px;
        height: auto;
        object-fit: contain;
    }

    .carousel-btn {
        position: absolute;
        background-color: white;
        color: #333;
        border: 1px solid #ccc;
        border-radius: 10%;
        padding: 0px;
        cursor: pointer;
        font-size: 15px;
        width: 40px;
        height: 40px;
        text-align: center;
        z-index: 10;
    }

    .btn-up {
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
    }

    .btn-down {
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
    }
    
    /* Button colors */
    .bg-blackgreen {
        background-color: #25D366;
        color: white;
    }
    
    .bg-blue {
        background-color: #1877F2;
        color: white;
    }
    
    /* Text colors */
    .text-warning {
        color: #FFC107 !important;
    }
    
    .text-gray {
        color: #6c757d !important;
    }
    
    /* Horizontal thumbnail carousel for mobile */
    .mobile-thumbnails {
        display: none; /* Hidden by default, shown on mobile */
        overflow-x: auto;
        white-space: nowrap;
        padding: 10px 0;
        gap: 10px;
    }
    
    .mobile-thumbnails img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        margin-right: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block;
    }
    
    .mobile-thumbnails img.active {
        border: 2px solid #008080;
    }
    
    /* Swiper styles for related products */
    .tab-image {
        max-width: 100%;
        max-height: 180px;
        object-fit: contain;
    }
    
    .product-title {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 3em;
    }
    
    .product-item {
        transition: all 0.3s ease;
        border: 1px solid #f0f0f0;
        border-radius: 8px;
        overflow: hidden;
        height: 100%;
    }
    
    .product-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .swiper-buttons button {
        width: 30px;
        height: 30px;
        padding: 0;
        margin: 0 2px;
    }
    
    /* Product title for mobile - prevent long titles from breaking layout */
    .product-title-mobile {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 767px) {
        /* Hide desktop carousel on mobile */
        .carousel-wrapper {
            display: none;
        }
        
        /* Show mobile thumbnails */
        .mobile-thumbnails {
            display: flex;
        }
        

        
        /* Fix padding for product details */
        .ps-5 {
            padding-left: 1rem !important;
        }
        
        /* Image sizing for mobile */
        .custom-size-main {
            max-width: 100%;
            height: auto;
            max-height: 300px;
        }
        
        /* Stack detail items vertically on mobile */
        .detail-row {
            flex-direction: column;
        }
        
        .detail-row > div {
            width: 100%;
            margin-bottom: 10px;
        }
        
        /* Remove left margin on mobile as items stack */
        .ms-5 {
            margin-left: 0 !important;
            margin-top: 10px;
        }
        
        /* Adjust heading sizes for mobile */
        h2 {
            font-size: 1.5rem;
        }
        
        h3 {
            font-size: 1.2rem;
        }
        
        h4, h5 {
            font-size: 1rem;
        }
        
        /* Social/contact buttons stack better on mobile */
        .social-buttons {
            flex-direction: column;
            gap: 10px;
        }
        
        .social-buttons .btn {
            margin-bottom: 10px;
        }
        

        /* Mobile styles for swiper */
        .section-header {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .section-header .d-flex {
            width: 100%;
            margin-top: 10px;
            justify-content: space-between !important;
        }
        
        .section-title {
            font-size: 1.3rem;
        }
        
        .swiper-buttons button {
            width: 25px;
            height: 25px;
            font-size: 12px;
        }
    }
</style>

<div class="bg-light">
  <div class="container mx-auto d-flex flex-column">
    <!-- Breadcrumb -->
    <div class="mt-4 mt-md-5">
      <%- include('../partials/breadcrumb', { 
        items: [
          { name: 'หน้าแรก', url: '/', icon: 'fa-solid fa-home' },
          { name: 'สินค้าทั้งหมด', url: '/shop/products', icon: 'fab fa-product-hunt' },
          { name: product.name,icon:'fas fa-box', active: true }
        ],
        style: 'modern'
      }) %>
    </div>

    <div class="mt-2 mb-5">
      <div class="row">
        <!-- Desktop vertical thumbnails (hidden on mobile) -->
        <div class="col-1 d-none d-md-block">
          <% if (product.images && product.images.length > 0) { %>
            <div class="carousel-wrapper">
              <div class="carousel-container">
                <div class="carousel-inner" id="carouselItems">
                  <% 
                    // หารูปที่เป็นรูปหลัก
                    const featuredIndex = product.images.findIndex(img => img.isFeatured);
                    const orderedImages = [...product.images];
                    
                    // ถ้ามีรูปหลัก ให้สลับมาอยู่ลำดับแรก
                    if (featuredIndex > 0) {
                      [orderedImages[0], orderedImages[featuredIndex]] = [orderedImages[featuredIndex], orderedImages[0]];
                    }
                  %>
                  
                  <% orderedImages.forEach((image, index) => { %>
                    <div class="carousel-item">
                      <img src="<%= image.url %>" alt="<%= product.name %>" class="custom-size" 
                           onclick="setMainImage('<%= image.url %>', <%= index %>)">
                    </div>
                  <% }) %>
                </div>
              </div>
              
              <!-- Navigation buttons -->
              <% if (product.images && product.images.length > 3) { %>
                <button class="carousel-btn btn-up" onclick="moveCarousel(-1)">
                  <i class="fas fa-arrow-up"></i>
                </button>
                <button class="carousel-btn btn-down" onclick="moveCarousel(1)">
                  <i class="fas fa-arrow-down"></i>
                </button>
              <% } %>
            </div>
          <% } %>
        </div>

        <!-- Main product image -->
        <div class="col-12 col-md-5 text-center">
          <div class="d-flex justify-content-center align-items-center mb-3">
            <% if (product.images && product.images.length > 0) { %>
              <% 
                // หารูปที่เป็นรูปหลัก
                const featuredImage = product.images.find(img => img.isFeatured) || product.images[0];
              %>
              <img id="mainImage" src="<%= featuredImage.url %>" alt="<%= product.name %>" class="custom-size-main">
            <% } else { %>
              <div class="bg-light d-flex flex-column justify-content-center align-items-center py-5 rounded" style="height: 300px; width: 100%;">
                <i class="bi bi-image fs-1 text-muted"></i>
                <p class="text-muted mt-2">ไม่มีรูปภาพ</p>
              </div>
            <% } %>
          </div>
          
          <!-- Mobile horizontal thumbnails (shown only on mobile) -->
          <% if (product.images && product.images.length > 0) { %>
            <div class="mobile-thumbnails d-md-none">
              <% product.images.forEach((image, index) => { %>
                <img src="<%= image.url %>" alt="<%= product.name %>" 
                     onclick="setMainImage('<%= image.url %>', <%= index %>)" 
                     class="<%= (image.isFeatured) ? 'active' : '' %>">
              <% }) %>
            </div>
          <% } %>
        </div>

        <!-- Product details -->
        <div class="col-12 col-md-6 ps-md-5 mt-3 mt-md-0 ">
          <h3 class="text-dark mb-2 product-title-mobile mt-5"><b><%= product.name %></b></h3>
          
          <div class="d-flex justify-content-between align-items-center mb-1"></div>
            <span class="text-gray me-5">รหัสสินค้า: <%= product.code %></span>
            <span class="text-gray">
              <i class="fa-solid fa-eye"></i> <%= displayViews || 0 %>
            </span>
          
          
          <h2 class="text-cyan my-3"><b><%= product.price || 'ไม่ระบุราคา' %> บาท</b></h2>
          
          <div class="row g-2 mb-3">
            <div class="col-12 col-sm-6">
              <h5 class="mb-1"><strong>หมวดหมู่:</strong> 
                <% if (product.category) { %>
                  <a href="/shop/category/<%= product.category.id %>" class="text-gray text-decoration-none">
                    <%= product.category.name %>
                  </a>
                <% } else { %>
                  <span class="text-gray">ไม่ระบุ</span>
                <% } %>
              </h5>
            </div>
            <div class="col-12 col-sm-6">
              <h5 class="mb-1"><strong>คงเหลือ:</strong> <span class="text-gray"><%= product.stock || 0 %> ชิ้น</span></h5>
            </div>
            <div class="col-12">
              <h5 class="mb-1"><strong>สถานะ:</strong> <span class="text-gray">พร้อมจัดส่ง</span></h5>
            </div>
          </div>

          <hr class="my-3">

          <!-- Contact buttons -->
          <div class="text-center mt-4">
            <h4 class="text-dark mb-3">ติดต่อสั่งซื้อ</h4>
            <div class="d-flex flex-wrap justify-content-center gap-3">
              <a href="#" class="btn bg-blackgreen px-4 py-2" data-bs-toggle="modal" data-bs-target="#lineModal">
                <i class="fab fa-line me-2"></i> Line
              </a>
              <a href="https://www.facebook.com/profile.php?id=61570979126029" target="_blank" class="btn bg-blue px-4 py-2">
                <i class="fab fa-facebook-f me-2"></i> Facebook
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Line QR Code Modal -->
      <div class="modal fade" id="lineModal" tabindex="-1" aria-labelledby="lineModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="lineModalLabel">ติดต่อผ่าน Line</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ปิด"></button>
            </div>
            <div class="modal-body text-center">
              <!-- QR Code -->
              <img src="/images/qrcodeline.jpg" alt="QR Code Line" class="img-fluid" style="max-width: 250px;">
              <!-- Line ID -->
              <p class="mt-3 fw-bold">Line ID: 0864562964</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Product details sections -->
      <div class="mt-4 mt-md-5">
        <h3 class="text-dark mb-3"><b>รายละเอียดสินค้า</b></h3>
        
        <div class="row mb-3 description-section">
          <div class="col-12 col-md-3">
            <h4 class="text-dark"><b>ข้อมูล |</b></h4>
          </div>
          <div class="col-12 col-md-9">
            <div class="d-flex flex-column flex-md-row mb-3">
              <h5 class="me-md-4 mb-2 mb-md-0"><b class="text-dark">คงเหลือ:</b> <%= product.stock || 0 %></h5>
              <h5 class="me-md-4 mb-2 mb-md-0"><b class="text-dark">วันลงสินค้า:</b> <%= new Date(product.createdAt).toLocaleDateString('th-TH') %></h5>
              <h5><b class="text-dark">แก้ไขล่าสุด:</b> <%= new Date(product.updatedAt).toLocaleDateString('th-TH') %></h5>
            </div>
          </div>
        </div>
        
        <div class="row mb-3 description-section">
          <div class="col-12 col-md-3">
            <h4 class="text-dark"><b>รายละเอียด |</b></h4>
          </div>
          <div class="col-12 col-md-9">
            <h5 class="text-break"><%= product.description || 'ไม่มีรายละเอียด' %></h5>
          </div>
        </div>
        
        <div class="row mb-3 description-section">
          <div class="col-12 col-md-3">
            <h4 class="text-dark"><b>วิธีการสั่งซื้อ |</b></h4>
          </div>
          <div class="col-12 col-md-9">
            <div class="d-flex flex-column flex-md-row mb-md-2">
              <h5 class="me-md-4 mb-2 mb-md-0">สำนักงาน: 043-393939</h5>
              <h5 class="me-md-4 mb-2 mb-md-0">มือถือ: 086-4562964</h5>
              <h5>ID line: 0864562964</h5>
            </div>
          </div>
        </div>
        
        <div class="row mb-3 description-section">
          <div class="col-12 col-md-3">
            <h4 class="text-dark"><b>วิธีการจัดส่ง |</b></h4>
          </div>
          <div class="col-12 col-md-9">
            <h5>บริการขนส่งของรัฐและเอกชน เช่น ไปรษณีย์, Inter express, Kerry express</h5>
          </div>
        </div>
      </div>
      
      <!-- Related products with Swiper.js carousel -->
      <% if (relatedProducts && relatedProducts.length > 0) { %>
        <section class="pt-4 pb-5">
          <div class="container-lg px-0">
            <div class="row">
              <div class="col-md-12">
                <div class="section-header d-flex flex-wrap justify-content-between my-4">
                  <h2 class="section-title text-dark">สินค้าที่เกี่ยวข้อง</h2>
                  <div class="d-flex align-items-center">
                    <a href="/shop/category/<%= product.category ? product.category.id : '' %>" class="btn bg-teal text-light rounded-1 me-2">ดูทั้งหมด</a>
                    <div class="swiper-buttons">
                      <button class="swiper-prev related-carousel-prev btn bg-teal text-light">❮</button>
                      <button class="swiper-next related-carousel-next btn bg-teal text-light">❯</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-12">
                <div class="related-carousel swiper">
                  <div class="swiper-wrapper">
                    <% relatedProducts.forEach(related => { %>
                      <div class="swiper-slide">
                        <div class="product-item h-100 border shadow-sm rounded">
                          <a href="/shop/product/<%= related.id %>" class="text-decoration-none d-block h-100">
                            <figure class="m-0 p-3 text-center">
                              <% if (related.images && related.images.length > 0) { %>
                                <% 
                                  // หารูปที่เป็นรูปหลัก
                                  const featuredImage = related.images.find(img => img.isFeatured) || related.images[0];
                                %>
                                <img src="<%= featuredImage.url %>" alt="<%= related.name %>" class="tab-image" style="height: 180px; object-fit: contain;">
                              <% } else { %>
                                <div class="bg-light d-flex justify-content-center align-items-center py-4" style="height: 180px;">
                                  <i class="bi bi-image fs-1 text-muted"></i>
                                </div>
                              <% } %>
                            </figure>
                            <div class="d-flex flex-column text-center p-3 pt-0">
                              <h3 class="fs-6 fw-normal text-dark product-title"><%= related.name %></h3>
                              <div class="d-flex justify-content-center align-items-center gap-2 mt-1">
                                <span class="text-dark fw-semibold"><%= related.price || 'ไม่ระบุราคา' %> ฿</span>
                              </div>

                            </div>
                          </a>
                        </div>
                      </div>
                    <% }) %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      <% } %>
      
      <!-- Back button -->
      <div class="text-center mt-4 mb-4">
        <a href="/shop/category/<%= product.category ? product.category.id : '' %>" class="btn btn-outline-dark">
          <i class="bi bi-arrow-left me-2"></i>
          กลับไปยังรายการสินค้า
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // ฟังก์ชันเลื่อน carousel
  let currentIndex = 0;
  const itemsPerPage = 3; // จำนวนรูปที่แสดงใน carousel

  function moveCarousel(direction) {
    // ตรวจสอบว่าอยู่ในหน้าจอมือถือหรือไม่
    if (window.innerWidth <= 767) return;
    
    const items = document.querySelectorAll('.carousel-item');
    const totalItems = items.length;
    
    if (totalItems <= itemsPerPage) return; // ถ้ามีรูปน้อยกว่าหรือเท่ากับที่แสดงได้ ไม่ต้องเลื่อน
    
    const carouselInner = document.getElementById('carouselItems');

    currentIndex += direction;

    if (currentIndex < 0) {
      currentIndex = totalItems - 1; // เลื่อนกลับไปที่ภาพสุดท้าย
    } else if (currentIndex >= totalItems) {
      currentIndex = 0; // เลื่อนกลับไปที่ภาพแรก
    }

    // เลื่อน carousel
    const offset = -currentIndex * 150; // ขนาดของแต่ละภาพ
    carouselInner.style.transform = `translateY(${offset}px)`;
  }

  // ฟังก์ชันเปลี่ยนรูปหลัก
  function setMainImage(imageUrl, index) {
    document.getElementById('mainImage').src = imageUrl;
    
    // ถ้าอยู่ในมือถือ ให้เปลี่ยนสถานะ active ของ thumbnail
    if (window.innerWidth <= 767) {
      const thumbnails = document.querySelectorAll('.mobile-thumbnails img');
      thumbnails.forEach((thumb, i) => {
        if (i === index) {
          thumb.classList.add('active');
        } else {
          thumb.classList.remove('active');
        }
      });
    }
  }
  
  // ตรวจสอบการเปลี่ยนขนาดหน้าจอ
  window.addEventListener('resize', function() {
    // ถ้าเปลี่ยนเป็นหน้าจอขนาดใหญ่ รีเซ็ต carousel
    if (window.innerWidth > 767) {
      const carouselInner = document.getElementById('carouselItems');
      if (carouselInner) {
        currentIndex = 0;
        carouselInner.style.transform = `translateY(0)`;
      }
    }
  });

  // Swiper initialization for related products carousel
  document.addEventListener('DOMContentLoaded', function() {
    // สร้าง Swiper สำหรับสินค้าที่เกี่ยวข้อง
    var relatedCarousel = new Swiper(".related-carousel", {
      slidesPerView: 2,
      spaceBetween: 10,
      navigation: {
        nextEl: ".related-carousel-next",
        prevEl: ".related-carousel-prev",
      },
      breakpoints: {
        576: {
          slidesPerView: 2,
          spaceBetween: 15,
        },
        768: {
          slidesPerView: 3,
          spaceBetween: 20,
        },
        992: {
          slidesPerView: 4,
          spaceBetween: 20,
        },
        1200: {
          slidesPerView: 5,
          spaceBetween: 20,
        },
      },
    });
  });
</script>